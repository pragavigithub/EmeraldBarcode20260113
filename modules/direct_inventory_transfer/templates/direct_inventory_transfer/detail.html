{% extends "base.html" %}
{% block title %}Direct Inventory Transfer - {{ transfer.transfer_number }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">Direct Inventory Transfer</h1>
            <p class="text-muted">{{ transfer.transfer_number }}</p>
        </div>
        <a href="{{ url_for('direct_inventory_transfer.index') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to List
        </a>
    </div>

    <!-- Transfer Info -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="mb-0">Transfer Information</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>From Warehouse:</strong> <span class="badge bg-info">{{ transfer.from_warehouse }}</span></p>
                            <p><strong>To Warehouse:</strong> <span class="badge bg-success">{{ transfer.to_warehouse }}</span></p>
                        </div>
                        <div class="col-md-6">
                            {% if transfer.from_bin %}
                            <p><strong>From Bin:</strong> {{ transfer.from_bin }}</p>
                            {% endif %}
                            {% if transfer.to_bin %}
                            <p><strong>To Bin:</strong> {{ transfer.to_bin }}</p>
                            {% endif %}
                        </div>
                    </div>
                    {% if transfer.notes %}
                    <p><strong>Notes:</strong> {{ transfer.notes }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="mb-0">Status</h6>
                </div>
                <div class="card-body">
                    <p>
                        {% if transfer.status == 'draft' %}
                            <span class="badge bg-secondary">Draft</span>
                        {% elif transfer.status == 'submitted' %}
                            <span class="badge bg-warning">Submitted</span>
                        {% elif transfer.status == 'qc_approved' %}
                            <span class="badge bg-success">QC Approved</span>
                        {% elif transfer.status == 'posted' %}
                            <span class="badge bg-primary">Posted</span>
                        {% elif transfer.status == 'rejected' %}
                            <span class="badge bg-danger">Rejected</span>
                        {% endif %}
                    </p>
                    <p><strong>Total Items:</strong> {{ transfer.items|length }}</p>
                    {% if transfer.sap_document_number %}
                    <p><strong>SAP Doc:</strong> {{ transfer.sap_document_number }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Add Item Form (only for draft status) -->
    {% if transfer.status == 'draft' %}
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-barcode"></i> Step 1: Scan Barcode / Enter Serial Number
            </h6>
        </div>
        <div class="card-body">
            <form id="addItemForm">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="serial_number_search" class="form-label">Serial Number <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="serial_number_search" name="serial_number_search" 
                                   placeholder="Scan or enter serial number" autofocus required>
                            <button type="button" class="btn btn-primary" id="btnSearchSerial">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                        <small class="text-muted">Enter serial number to fetch item details</small>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Item Description</label>
                        <input type="text" class="form-control" id="item_description_display" readonly>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label class="form-label">Item Code</label>
                        <input type="text" class="form-control" id="item_code_display" readonly>
                        <input type="hidden" id="item_code" name="item_code">
                        <input type="hidden" id="item_type" name="item_type" value="serial">
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="quantity" class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="quantity" name="quantity" 
                               value="1" readonly>
                    </div>
                </div>

                <div class="text-end">
                    <button type="submit" class="btn btn-success" id="btnAddItem" disabled>
                        <i class="fas fa-plus"></i> Add Item
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}
    
    <!-- Serials Modal -->
    <div class="modal fade" id="serialsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="serialsModalTitle">Serial Numbers</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="serialsModalList" class="d-flex flex-wrap gap-2">
                        <!-- Serials will be inserted here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Items Table -->
    <div class="card shadow">
        <div class="card-header py-3">
            <h6 class="mb-0">Transfer Items</h6>
        </div>
        <div class="card-body">
            {% if transfer.items %}
            <div class="table-responsive">
                <table class="table table-bordered" width="100%">
                    <thead>
                        <tr>
                            <th>Item Code</th>
                            <th>Description</th>
                            <th>Type</th>
                            <th>Quantity</th>
                            <th>Batch/Serial</th>
                            <th>Status</th>
                            {% if transfer.status == 'draft' %}
                            <th>Actions</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody id="itemsTableBody">
                        {% for item in transfer.items %}
                        {% set sns = (item.serial_numbers|from_json) if item.item_type == 'serial' and item.serial_numbers else [] %}
                        <tr id="item-{{ item.id }}">
                            <td>{{ item.item_code }}</td>
                            <td>{{ item.item_description }}</td>
                            <td>
                                {% if item.item_type == 'serial' %}
                                    <span class="badge bg-warning" style="cursor: pointer;" 
                                          onclick="viewSerials('{{ item.item_code }}', {{ sns|tojson|safe }})">Serial</span>
                                {% elif item.item_type == 'batch' %}
                                    <span class="badge bg-info">Batch</span>
                                {% else %}
                                    <span class="badge bg-secondary">None</span>
                                {% endif %}
                            </td>
                            <td>{{ item.quantity }}</td>
                            <td>
                                {% if item.item_type == 'serial' and sns %}
                                    <div class="d-flex align-items-center">
                                        <button type="button" class="btn btn-sm btn-info rounded-pill me-2" 
                                                onclick="viewSerials('{{ item.item_code }}', {{ sns|tojson|safe }})">
                                            {{ sns[0] }}
                                            {% if sns|length > 1 %}
                                                <span class="ms-1">(+{{ sns|length - 1 }})</span>
                                            {% endif %}
                                        </button>
                                        <small class="text-muted">{{ sns|length }} serial(s)</small>
                                    </div>
                                {% elif item.item_type == 'batch' and item.batch_number %}
                                    <span class="badge bg-warning">{{ item.batch_number }}</span>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if item.validation_status == 'validated' %}
                                    <span class="badge bg-success">Validated</span>
                                {% else %}
                                    <span class="badge bg-danger">Failed</span>
                                {% endif %}
                            </td>
                            {% if transfer.status == 'draft' %}
                            <td>
                                <button class="btn btn-sm btn-info me-1" onclick="editItem({{ item.id }}, '{{ item.item_type }}', {{ item.quantity }}, '{{ item.batch_number or '' }}', '{{ (item.serial_numbers|from_json)|join(',') if item.serial_numbers else '' }}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteItem({{ item.id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Submit Button -->
            {% if transfer.status == 'draft' and transfer.items %}
            <div class="text-end mt-3">
                <button type="button" class="btn btn-primary" onclick="submitTransfer()">
                    <i class="fas fa-paper-plane"></i> Submit for QC Approval
                </button>
            </div>
            {% endif %}
            
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-inbox fa-3x text-gray-300 mb-3"></i>
                <p class="text-muted">No items added yet. Scan a barcode or enter an item code to add items.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
const transferId = {{ transfer.id }};

document.getElementById('btnSearchSerial').addEventListener('click', function() {
    searchSerial();
});

document.getElementById('serial_number_search').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        searchSerial();
    }
});

function searchSerial() {
    const serial = document.getElementById('serial_number_search').value.trim();
    if (!serial) {
        alert('Please enter a serial number');
        return;
    }

    const searchBtn = document.getElementById('btnSearchSerial');
    searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    searchBtn.disabled = true;

    fetch(`/direct-inventory-transfer/api/get-serial-location?serial_number=${encodeURIComponent(serial)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.value && data.value.length > 0) {
                const item = data.value[0];
                document.getElementById('item_code').value = item.ItemCode;
                document.getElementById('item_code_display').value = item.ItemCode;
                document.getElementById('item_description_display').value = item.itemName;
                document.getElementById('btnAddItem').disabled = false;
                alert('Serial number found and validated!');
            } else {
                alert('Serial number not found or invalid');
                resetAddItemForm();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error searching serial number');
        })
        .finally(() => {
            searchBtn.innerHTML = '<i class="fas fa-search"></i> Search';
            searchBtn.disabled = false;
        });
}

function resetAddItemForm() {
    document.getElementById('item_code').value = '';
    document.getElementById('item_code_display').value = '';
    document.getElementById('item_description_display').value = '';
    document.getElementById('btnAddItem').disabled = true;
}

document.getElementById('addItemForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const serial = document.getElementById('serial_number_search').value.trim();
    const itemCode = document.getElementById('item_code').value;
    
    if (!serial || !itemCode) {
        alert('Please search and validate a serial number first');
        return;
    }

    const formData = new FormData();
    formData.append('item_code', itemCode);
    formData.append('item_type', 'serial');
    formData.append('quantity', 1);
    formData.append('serial_numbers', serial);

    fetch(`/direct-inventory-transfer/${transferId}/add_item`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error adding item');
    });
});

function deleteItem(itemId) {
    if (!confirm('Are you sure you want to delete this item?')) {
        return;
    }

    fetch(`/direct-inventory-transfer/items/${itemId}/delete`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById(`item-${itemId}`).remove();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting item');
    });
}

function editItem(itemId, itemType, quantity, batchNumber, serialNumbers) {
    let newQty = prompt("Enter new quantity:", quantity);
    if (newQty === null) return;
    
    let formData = new FormData();
    formData.append('quantity', newQty);
    
    if (itemType === 'serial') {
        let newSerials = prompt("Enter serial numbers (comma separated):", serialNumbers);
        if (newSerials === null) return;
        formData.append('serial_numbers', newSerials);
    } else if (itemType === 'batch') {
        let newBatch = prompt("Enter batch number:", batchNumber);
        if (newBatch === null) return;
        formData.append('batch_number', newBatch);
    }
    
    fetch(`/direct-inventory-transfer/items/${itemId}/edit`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating item');
    });
}

function submitTransfer() {
    if (!confirm('Are you sure you want to submit this transfer for QC approval?')) {
        return;
    }

    fetch(`/direct-inventory-transfer/${transferId}/submit`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error submitting transfer');
    });
}

function viewSerials(itemCode, serials) {
    document.getElementById('serialsModalTitle').innerText = `Serial Numbers for ${itemCode}`;
    const listContainer = document.getElementById('serialsModalList');
    listContainer.innerHTML = '';
    
    serials.forEach(sn => {
        const span = document.createElement('span');
        span.className = 'badge bg-info p-2';
        span.innerText = sn;
        listContainer.appendChild(span);
    });
    
    const modal = new bootstrap.Modal(document.getElementById('serialsModal'));
    modal.show();
}
</script>
{% endblock %}
